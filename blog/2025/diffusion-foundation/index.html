<!DOCTYPE html>
<html lang="en">

  <!-- Head -->
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">    <!-- Metadata, OpenGraph and Schema.org -->
    

    <!-- Standard metadata -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Foundation of Diffusion Models | Tuan-Anh  Bui</title>
    <meta name="author" content="Tuan-Anh  Bui">
    <meta name="description" content="Researcher in Generative AI and Trustworthy AI
">
    <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website">


    <!-- Bootstrap & MDB -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous">

    <!-- Bootstrap Table -->
    <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.css">

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

    <!-- Code Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light">

    

    <!-- Styles -->
    
    <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;">
    
    <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e">
    <link rel="canonical" href="https://tuananhbui89.github.io/blog/2025/diffusion-foundation/">

    <!-- Dark Mode -->
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark">
    <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script>
    <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script>
    

  </head>

  <!-- Body -->
  <body class="fixed-top-nav ">

    <!-- Header -->
    <header>

      <!-- Nav Bar -->
      <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
        <div class="container">
          <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Tuan-Anh </span>Bui</a>
          <!-- Navbar Toggle -->
          <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar top-bar"></span>
            <span class="icon-bar middle-bar"></span>
            <span class="icon-bar bottom-bar"></span>
          </button>

          <div class="collapse navbar-collapse text-right" id="navbarNav">
            <ul class="navbar-nav ml-auto flex-nowrap">

              <!-- About -->
              <li class="nav-item ">
                <a class="nav-link" href="/">about</a>
              </li>
              
              <!-- Blog -->
              <li class="nav-item active">
                <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a>
              </li>

              <!-- Other pages -->
              <li class="nav-item ">
                <a class="nav-link" href="/publications/">publications</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/projects/">projects</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/repositories/">repositories</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/teaching/"></a>
              </li>

              <!-- Toogle theme mode -->
              <li class="toggle-container">
                <button id="light-toggle" title="Change theme">
                  <i class="fas fa-moon"></i>
                  <i class="fas fa-sun"></i>
                </button>
              </li>
            </ul>
          </div>
        </div>
      </nav>

      <!-- Scrolling Progress Bar -->
      <progress id="progress" value="0">
        <div class="progress-container">
          <span class="progress-bar"></span>
        </div>
      </progress>
    </header>


    <!-- Content -->
    <div class="container mt-5">
      
        <!-- _layouts/post.html -->
<!-- Page/Post style -->
<style type="text/css">
  
</style>


<div class="post">

  <header class="post-header">
    <h1 class="post-title">Foundation of Diffusion Models</h1>
    <p class="post-meta">March 8, 2025</p>
    <p class="post-tags">
      <a href="/blog/2025"> <i class="fas fa-calendar fa-sm"></i> 2025 </a>
        ·  
        <a href="/blog/tag/reading">
          <i class="fas fa-hashtag fa-sm"></i> reading</a>  
          <a href="/blog/tag/diffusion">
          <i class="fas fa-hashtag fa-sm"></i> diffusion</a>  
          <a href="/blog/tag/genai">
          <i class="fas fa-hashtag fa-sm"></i> genai</a>  
          

    </p>
  </header>

  <article class="post-content">
    
    <div id="table-of-contents">
      <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2">
<a href="#what-are-diffusion-models">What are Diffusion Models?</a>
<ul>
<li class="toc-entry toc-h3"><a href="#advantages-of-diffusion-models">Advantages of Diffusion Models</a></li>
<li class="toc-entry toc-h3"><a href="#disadvantages-of-diffusion-models">Disadvantages of Diffusion Models</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#mathematical-foundation">Mathematical Foundation</a>
<ul>
<li class="toc-entry toc-h3"><a href="#ode">ODE</a></li>
<li class="toc-entry toc-h3"><a href="#sde">SDE</a></li>
<li class="toc-entry toc-h3"><a href="#elbo">ELBO</a></li>
<li class="toc-entry toc-h3"><a href="#tweedies-formula">Tweedie’s formula</a></li>
</ul>
</li>
<li class="toc-entry toc-h2">
<a href="#variants">Variants</a>
<ul>
<li class="toc-entry toc-h3"><a href="#ddpm">DDPM</a></li>
<li class="toc-entry toc-h3"><a href="#ddim">DDIM</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#noise-scheduling">Noise scheduling</a></li>
<li class="toc-entry toc-h2">
<a href="#guidanced-diffusion">Guidanced Diffusion</a>
<ul>
<li class="toc-entry toc-h3"><a href="#classifier-guidance">Classifier Guidance</a></li>
<li class="toc-entry toc-h3"><a href="#classifier-free-guidance">Classifier-free Guidance</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#latent-diffusion">Latent Diffusion</a></li>
<li class="toc-entry toc-h2">
<a href="#conditional-diffusion">Conditional Diffusion</a>
<ul>
<li class="toc-entry toc-h3"><a href="#control-net">Control-Net</a></li>
<li class="toc-entry toc-h3"><a href="#image-prompt">Image Prompt</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#diffusion-transformers">Diffusion Transformers</a></li>
<li class="toc-entry toc-h2"><a href="#image-inpainting-with-diffusion-models">Image Inpainting with Diffusion Models</a></li>
<li class="toc-entry toc-h2">
<a href="#accelerating-diffusion-models">Accelerating Diffusion Models</a>
<ul>
<li class="toc-entry toc-h3"><a href="#diffusion-distillation">Diffusion Distillation</a></li>
<li class="toc-entry toc-h3"><a href="#rectified-diffusion">Rectified Diffusion</a></li>
</ul>
</li>
</ul>
    </div>
    <hr>
    
    <div id="markdown-content">
      <p>(Work in progress I will gradually add more content when having more time:D Please stay tuned :D)</p>

<h2 id="what-are-diffusion-models">What are Diffusion Models?</h2>

<p>Diffusion models are a class of generative models that generate data by progressively denoising a sample from pure noise. They are inspired by <a href="https://en.wikipedia.org/wiki/Non-equilibrium_thermodynamics" rel="external nofollow noopener" target="_blank"><strong>non-equilibrium thermodynamics</strong></a> and are based on a forward and reverse diffusion process:</p>

<ol>
  <li>Forward Process (Diffusion Process): A data sample (e.g., an image) is gradually corrupted by adding Gaussian noise over multiple timesteps until it becomes nearly pure noise.</li>
  <li>Reverse Process (Denoising Process): A neural network learns to reverse this corruption by gradually removing noise step by step, reconstructing the original data distribution.</li>
</ol>

<figure style="text-align: center;">
  <iframe width="560" height="315" src="https://www.youtube.com/embed/JnIkGtkO-Js?si=faOgaMvGtqTLcG1T" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe>
  <figcaption>Diffusion - How molecules actually move</figcaption>
</figure>

<p><strong>Analogy: Ink Dissolving in Water</strong>
Imagine dropping a blob of ink into a glass of water:</p>

<ul>
  <li>Forward process (Diffusion Process): Initially, the ink is concentrated in one place (structured data). Over time, it spreads out randomly, blending with the water (adding noise). Eventually, the entire glass becomes a uniformly colored mixture, losing its original structure (complete noise).</li>
  <li>Reverse process (Denoising Process): If we had a way to perfectly reverse time, we could watch the ink particles retrace their paths, reassembling into the original drop (generating the original data from noise). Diffusion models learn to perform this “reverse process” step by step using machine learning.</li>
</ul>

<blockquote>
  <p><strong>Non-Equilibrium Thermodynamics</strong></p>

  <p>Thermodynamics studies <strong>how energy moves and changes</strong> in a system. In equilibrium thermodynamics, systems are in balance—nothing is changing. Non-equilibrium thermodynamics, on the other hand, deals with <strong>systems that are constantly evolving, moving between states of disorder and order</strong>.</p>

  <p>In diffusion models, the forward process (adding noise to data) and the reverse process (removing noise) resemble a non-equilibrium thermodynamic system because they describe an evolving state that moves from order (structured data) to disorder (pure noise) and back to order (reconstructed data).</p>
</blockquote>

<blockquote>
  <p><strong>Brownian Motion</strong></p>

  <p>Brownian motion <strong>describes the random movement</strong> of tiny particles (like pollen grains in water) due to <strong>collisions with molecules</strong>. This randomness is similar to how noise is added in diffusion models.</p>
</blockquote>

<h3 id="advantages-of-diffusion-models">Advantages of Diffusion Models</h3>

<p>Diffusion models offer several key advantages over traditional generative models like GANs and VAEs:</p>

<ol>
  <li>
    <p><strong>High-Fidelity Samples</strong>: Unlike VAEs and GANs which generate samples in one step, diffusion models create samples gradually by denoising. This step-by-step process allows the model to first establish coarse image structure before refining fine details, resulting in higher quality outputs.</p>
  </li>
  <li>
    <p><strong>Training Stability</strong>: Diffusion models are easier to train compared to GANs as they use a single tractable likelihood loss. They don’t suffer from training instabilities like mode collapse that often plague GANs.</p>
  </li>
  <li>
    <p><strong>Sample Diversity</strong>: Similar to VAEs, diffusion models maximize likelihood which ensures coverage of all modes in the training dataset. This leads to more diverse outputs compared to GANs which can suffer from mode collapse.</p>
  </li>
  <li>
    <p><strong>Flexible Architecture</strong>: The multi-step denoising process enables additional functionalities like inpainting or image-to-image generation by manipulating the input noise, without requiring architectural changes.</p>
  </li>
  <li>
    <p><strong>Consistent Quality</strong>: The gradual denoising process is more robust and consistent compared to GANs where quality can vary significantly between samples.</p>
  </li>
</ol>

<p>The main trade-off is generation speed - diffusion models require multiple neural network passes to generate samples, making them slower than single-pass models like GANs and VAEs. However, various sampling optimization techniques have been developed to significantly reduce this computational overhead.</p>

<h3 id="disadvantages-of-diffusion-models">Disadvantages of Diffusion Models</h3>

<p>While diffusion models have significant advantages, they also come with some trade-offs:</p>

<ul>
  <li>Slow Sampling: The reverse process requires multiple denoising steps, making inference slower compared to GANs.</li>
  <li>Compute Intensive: Training requires large amounts of data and computational power.</li>
  <li>Memory Usage: They require storing multiple intermediate noise distributions, making them more memory-intensive.</li>
  <li>Complex Implementation: The multi-step nature of diffusion models makes them more complex to implement compared to single-step models.</li>
</ul>

<h2 id="mathematical-foundation">Mathematical Foundation</h2>

<h3 id="ode">ODE</h3>

<p>An Ordinary Differential Equation (ODE) is a mathematical equation that describes how a function changes over time. In simple terms, it tells us how a quantity evolves continuously based on its current state.</p>

\[\frac{dx}{dt} = f(x, t)\]

<p>where \(x(t)\) is the state of the system - the function we want to solve -and \(t\) is time. \(f(x, t)\) defines how \(x\) changes over time.</p>

<h3 id="sde">SDE</h3>

<p>A general form of an SDE is:</p>

\[dx = f(x, t) dt + g(x, t) dW_t\]

<p>where \(f(x, t)dt\) is the drift term (deterministic change), and \(g(x, t) dW_t\) is the diffusion term (stochastic change). \(dW_t\) is the increment of a Wiener process (Brownian motion).</p>

<p>This equation describes how a system evolves over time with both deterministic trends and random fluctuations.
In the case of Diffusion Models, the drift term is the shift of the mean of the distribution, and the diffusion term is the spread of the distribution.</p>

<p><strong>Forward Process (Adding Noise)</strong></p>

<p>The forward diffusion process transform a data sample \(x_0\) into pure noise \(x_T\) over time:</p>

\[dx = f(x, t)dt + g(t) dW_t\]

<p>where \(f(x,t)\) represents a deterministic shift of the mean of the distribution, and \(g(t)\) represents a stochastic spread of the distribution - injecting Gaussian noise.</p>

<p><strong>Reverse Process (Removing Noise)</strong></p>

<p>The Reverse-Time SDE (by Anderson 1982) is:</p>

\[dx = \left[ f(x,t) - g^2(t) \nabla_x \log p_t(x) \right] dt + g(t) d\tilde{W}_t\]

<p>where \(\nabla_x \log p_t(x)\) is the score function, which estimates the structure of data at time \(t\) - how likely different data points are at each step.
\(d\tilde{W}_t\) is another Wiener process but in the reverse direction.</p>

<p>In the reverse process of diffusion models, we train a neural network to approximate the score function \(\nabla_x \log p_t(x)\).</p>

<h3 id="elbo">ELBO</h3>

<p><a href="https://en.wikipedia.org/wiki/Evidence_lower_bound" rel="external nofollow noopener" target="_blank"><strong>Evidence lower bound (ELBO)</strong></a> is a key concept in variational inference, which is used in VAEs to approximate the log-likelihood of the data.</p>

<p>Let \(X\) and \(Z\) be random variables, jointly distributed with distribution \(p_\theta\). For example, \(p_\theta(X)\) is the marginal distribution of \(X\), and \(p_\theta(Z \mid X)\) is the conditional distribution of \(Z\) given \(X\). Then, for a sample \(x \sim p_{\text{data}}\), and any distribution \(q_\phi\), the ELBO is defined as</p>

\[L(\phi, \theta; x) := \mathbb{E}_{z\sim q_\phi(\cdot|x)} \left[\ln \frac{p_\theta(x,z)}{q_\phi(z|x)}\right].\]

<p>The ELBO can equivalently be written as</p>

\[\begin{aligned}
L(\phi, \theta; x) &amp;= \mathbb{E}_{z\sim q_\phi(\cdot|x)}[\ln p_\theta(x,z)] + H[q_\phi(z \mid x)] \\
&amp;= \ln p_\theta(x) - D_{KL}(q_\phi(z \mid x) || p_\theta(z \mid x)).
\end{aligned}\]

<p>In the first line, \(H[q_\phi(z \mid x)]\) is the entropy of \(q_\phi\), which relates the ELBO to the Helmholtz free energy. In the second line, \(\ln p_\theta(x)\) is called the evidence for \(x\), and \(D_{KL}(q_\phi(z \mid x) \mid\mid p_\theta(z \mid x))\) is the Kullback-Leibler divergence between \(q_\phi\) and \(p_\theta\). Since the Kullback-Leibler divergence is non-negative, \(L(\phi, \theta; x)\) forms a lower bound on the evidence (ELBO inequality)</p>

\[\ln p_\theta(x) \geq \mathbb{E}_{z\sim q_\phi(\cdot|x)}\left[\ln \frac{p_\theta(x,z)}{q_\phi(z|x)}\right].\]

<p>Deep-dive topics about VAE might including:</p>

<ul>
  <li>Reparameterization Trick: <a href="https://en.wikipedia.org/wiki/Reparameterization_trick" rel="external nofollow noopener" target="_blank">How to sample from a distribution in a differentiable way - Wiki</a>
</li>
  <li>The problem of KL divergence: <a href="https://andrewcharlesjones.github.io/journal/klqp.html" rel="external nofollow noopener" target="_blank">mode seeking vs mode covering</a> by Andy Jones</li>
  <li><a href="https://lilianweng.github.io/posts/2018-08-12-vae/#beta-vae" rel="external nofollow noopener" target="_blank">A nice property of VAEs: Disentanglement Representation Learning</a></li>
</ul>

<h3 id="tweedies-formula">Tweedie’s formula</h3>

<h2 id="variants">Variants</h2>

<h3 id="ddpm">DDPM</h3>

<p>Read more about DDPM in another blog post <a href="/blog/2023/diffusion-tutorial/">here</a></p>

<h3 id="ddim">DDIM</h3>

<p>Read more about DDIM in another blog post <a href="/blog/2023/diffusion-tutorial-p2/">here</a></p>

<p>Key concepts of DDIM:</p>

<ul>
  <li>DDIM utilizes a <strong>non-Markovian transition</strong> during inference, enables faster sampling.</li>
  <li>Can use the same training process as DDPM, e.g., we can use pretrained DDPM models to generate data.</li>
</ul>

<p>The sampling process of DDIM is as follows:</p>

\[x_{t-1} = \sqrt{\alpha_{t-1}} \left(\frac{x_t - \sqrt{1-\alpha_t}\epsilon_\theta^{(t)}(x_t)}{\sqrt{\alpha_t}}\right) + \sqrt{1-\alpha_{t-1}-\sigma_t^2} \cdot \epsilon_\theta^{(t)}(x_t) + \sigma_t\epsilon_t\]

<p>where the first term represents the “predicted $x_0$”, the second term is the “direction pointing to $x_t$”, and the last term is random noise.</p>

<p>By setting \(\sigma_t = 0\) for all \(t\), DDIM becomes a deterministic process given \(x_{t-1}\) and \(x_0\), except for \(t=1\). In other words, the intermediate steps \(x_{T-1}, x_{T-2}, \ldots, x_1\) are deterministic given starting noise \(x_T\).</p>

<h2 id="noise-scheduling">Noise scheduling</h2>

<p>Noise scheduling in diffusion models refers to how noise is gradually added to data in the forward process and how it is removed in the reverse process. The choice of noise schedule significantly impacts the model’s performance, sample quality, and training efficiency.</p>

<p>We follow the DDIM convention, where \(0 &lt; \bar{\alpha}_t &lt; 1, \beta_t = 1 - \bar{\alpha}_t\) and \(\alpha_t = \prod_{i=1}^{t} \bar{\alpha}_i\) is the cumulative noise level at time \(t\), and \(\beta_t\) is the noise level at time \(t\). With this convention, \(x_t = \sqrt(\alpha_t) x_0 + \sqrt(1-\alpha_t) \epsilon\), and \(\alpha_T \approx 0\) when \(t \rightarrow T\) while \(\alpha_0 \approx 1\) when \(t \rightarrow 0\).</p>

<p>Common principles of noise scheduling:</p>

<ul>
  <li>Add large amount of noise at \(t\) large while small amount of noise at \(t\) small. \(t=0\) means clean data, \(t=T\) means pure noise.</li>
  <li>The speed of change (acceleration, or \(\frac{d\beta_t}{dt}\)) should also has some proper speed (but I am not sure :D)</li>
</ul>

<p>Common noise schedules:</p>

<ul>
  <li>
<strong>Linear</strong>: \(\alpha_t = \frac{t}{T}\) or \(\beta_t = \beta_{\min} + (\beta_{\max} - \beta_{\min})\frac{t}{T}\). Issue: early timesteps do not add enough noise, and late timesteps can add too much noise.</li>
  <li>
<strong>Cosine</strong>: \(\beta_t = \beta_{\min} + 0.5 (\beta_{\max} - \beta_{\min}) ( 1 + \cos(\frac{t}{T} \pi))\). Intuition is that adding more gradually at the start and <strong>faster at the end</strong>.</li>
  <li>
<strong>Exponential</strong>: \(\beta_t = \beta_{\max} (\beta_{\min} / \beta_{\max})^{\frac{t}{T}}\)</li>
</ul>

<h2 id="guidanced-diffusion">Guidanced Diffusion</h2>

<p>Resources:</p>

<ul>
  <li>A great blog from Sander Dieleman: <a href="https://sander.ai/2022/05/26/guidance.html" rel="external nofollow noopener" target="_blank">Guidance: a cheat code for diffusion models</a> and <a href="https://sander.ai/2023/08/28/geometry.html" rel="external nofollow noopener" target="_blank">the geometry of diffusion guidance</a>.</li>
</ul>

<p><strong>Why Guidance?</strong></p>

<p>Guidance is a method to control the generation process so that the ouput is sample from a conditional distribution \(p(x \mid y)\), where \(y\) is a condition - such as a text prompt - rather than a generic \(p(x)\).</p>

<h3 id="classifier-guidance">Classifier Guidance</h3>

<p>In order to get the conditional score function \(\nabla_x \ln p(x \mid y)\), we can use Bayes rule to decompose the score function into an unconditional component and a conditional one:</p>

\[p(x \mid y) = \frac{p(y \mid x) p(x)}{p(y)}\]

\[\log p(x \mid y) = \log p(y \mid x) + \log p(x) - \log p(y)\]

\[\nabla_x \log p(x \mid y) = \nabla_x \log p(y \mid x) + \nabla_x \log p(x) - \nabla_x \log p(y)\]

<p>where \(\nabla_x \log p(x)\) is the score function of the unconditional model. \(\nabla_x \log p(y) = 0\) since \(p(y)\) is independent of \(x\).</p>

<p>The term \(\nabla_x \log p(y \mid x)\) means the direction pointing to \(y\) given \(x\).</p>

<ul>
  <li>In the begining of the inference process, i.e., large \(t\), when \(x_t\) still has a lot of noise, \(\nabla_x \log p(y \mid x)\) is close to \(0\), means that there is no clear information of \(y\).</li>
  <li>In the later stages, i.e., small \(t\), when \(x_t\) is less noisy and closer to \(x_0\), \(\nabla_x \log p(y \mid x)\) is larger, means that \(x_t\) has more information of \(y\), i.e., larger \(p(y \mid x)\).</li>
</ul>

<p><strong>How to obtain \(\nabla_x \log p(y \mid x)\)?</strong></p>

<p>\(p(y \mid x)\) means the probability of a condition \(y\) given \(x\).
In a simple case, where \(y\) is just a image class, like a <code class="language-plaintext highlighter-rouge">cat</code>, the probability \(p(y=\text{cat} \mid x)\) can be simply obtained from a pre-trained classifier.</p>

<p>However, in a more complex case, where \(y\) is a text prompt like a black cat with red eyes and blue fur, a pre-trained classifier is not expressive enough, i.e., it cannot distinguish between \(y_1\) <code class="language-plaintext highlighter-rouge">a black cat with red eyes and blue fur</code> vs \(y_2\) <code class="language-plaintext highlighter-rouge">a white cat with blue eyes and red fur</code> or mathematically \(p(y_1 \mid x) \neq p(y_2 \mid x)\).</p>

<p>In other words, the quality - diversity of the generated image \(x\) strongly depends on the capability of the conditional model \(p(y \mid x)\). For example:</p>

<ul>
  <li>If \(p_\phi(y \mid x)\) is a binary classifier <code class="language-plaintext highlighter-rouge">hot dog</code> or <code class="language-plaintext highlighter-rouge">not hot dog</code>, then output image \(x \sim p_\theta(x \mid y)\) can be either <code class="language-plaintext highlighter-rouge">hot dog</code> or <code class="language-plaintext highlighter-rouge">not hot dog</code> only, even \(p_\theta(x)\) was trained from a massive dataset with many more classes rather than just two classes.</li>
  <li>If you want to generate an image \(x\) from a complex prompt \(y\), you need a powerful model like CLIP as the conditional model \(p_\phi(y \mid x)\).</li>
</ul>

<p>To balance between the specificity (i.e., high \($p(y \mid x\))) and diversity/quality (i.e., \(p(x \mid y) \approx p(x)\)), we use a guidance scale \(\gamma\) to control the trade-off between the two.</p>

\[\nabla_x \log p(x \mid y) =  \nabla_x \log p(x) + \gamma \nabla_x \log p(y \mid x)\]

<p>where \(\gamma\) is the guidance scale. A big \(\gamma\) means the model is less creative but more following the condition \(y\).</p>

<h3 id="classifier-free-guidance">Classifier-free Guidance</h3>

<p>The main limitation of the above approach is that the quality of the generated image \(x\) strongly depends on the capability of the conditional model \(p(y \mid x)\).</p>

<p>If your model \(p(x)\) was trained on Image-Net dataset, but you want to generate an CT-scan medical image, then even with a powerful conditional model \(p(y \mid x)\), you will not get that.</p>

<p>The idea of classifier-free guidance cames from the <strong>Bayes Classifier</strong> - if you have trained a powerful unconditional generative model \(p(x)\) then you can use it as a classifier \(p(y \mid x)\) as follows:</p>

\[p(y \mid x) = \frac{p(x \mid y) p(y)}{p(x)}\]

<h2 id="latent-diffusion">Latent Diffusion</h2>

<h2 id="conditional-diffusion">Conditional Diffusion</h2>

<h3 id="control-net">Control-Net</h3>

<h3 id="image-prompt">Image Prompt</h3>

<p>Beyond controlling the generation process using text prompt, there is a hot topic in the community to control using image information/layout/prompt - which has a huge potential in applications, e.g., image inpainting, image-to-image generation, etc. In the standard Stable Diffusion, the condition embedding \(c_t\) is just a text embedding \(c_t = E_t(y)\) where \(y\) is the text prompt and \(E_t\) is a pre-trained text encoder such as CLIP.
IP-Adapter [1] proposes to use an additional image encoder to extract the image embedding from a reference image \(c_i = E_i(x)\) and then project it into the original condition space.
The objective function for IP-Adapter is:</p>

\[\mathcal{L}_{IP} = \mathbb{E}_{z, c, \epsilon, t} \left[ \mid \mid \epsilon - \epsilon_\theta(z_t \mid c_i, c_t, t) \mid \mid_2^2 \right]\]

<p>The cross-attention layer is also modified from the one in Stable Diffusion to include the image embedding \(c_i\) as a condition.</p>

\[\text{Attention}(Q, K_i, K_t, V_i, V_t) = \lambda \text{softmax}\left(\frac{QK_i^T}{\sqrt{d}} + c_i\right)V_i + \text{softmax}\left(\frac{QK_t^T}{\sqrt{d}}\right)V_t\]

<p>where \(Q=z W_Q\), \(K_i = c_i W_K^i\), \(K_t = c_t W_K^t\), \(V_i = c_i W_V^i\), \(V_t = c_t W_V^t\), and \(W_Q\), \(W_K^i\), \(W_K^t\), \(W_V^i\), \(W_V^t\) are the weights of the linear layers.
The model becomes the original Stable Diffusion when \(\lambda = 0\).</p>

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0 text-center">
        <figure>

  <picture>
    
    <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/diffusion-foundation/2025-03-20-07-02-10-480.webp"></source>
    <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/diffusion-foundation/2025-03-20-07-02-10-800.webp"></source>
    <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/diffusion-foundation/2025-03-20-07-02-10-1400.webp"></source>
    

    <!-- Fallback to the original file -->
    <img src="/assets/img/diffusion-foundation/2025-03-20-07-02-10.png" class="img-fluid rounded z-depth-1" width="600" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();">
  </picture>

</figure>

    </div>
</div>

<p>References:</p>

<ul>
  <li>[1] <a href="https://arxiv.org/pdf/2308.06721" rel="external nofollow noopener" target="_blank">IP-Adapter: Text Compatible Image Prompt Adapter for Text-to-Image Diffusion Models</a>
</li>
  <li>[2] <a href="https://openreview.net/pdf?id=PJqP0wyQek#page=1.93" rel="external nofollow noopener" target="_blank">MS-DIFFUSION: MULTI-SUBJECT ZERO-SHOT IMAGE PERSONALIZATION WITH LAYOUT GUIDANCE</a>
</li>
</ul>

<h2 id="diffusion-transformers">Diffusion Transformers</h2>

<h2 id="image-inpainting-with-diffusion-models">Image Inpainting with Diffusion Models</h2>

<h2 id="accelerating-diffusion-models">Accelerating Diffusion Models</h2>

<h3 id="diffusion-distillation">Diffusion Distillation</h3>

<h3 id="rectified-diffusion">Rectified Diffusion</h3>

<p>References:</p>

<ul>
  <li>[1] <a href="https://arxiv.org/pdf/2209.03003" rel="external nofollow noopener" target="_blank">Flow straight and fast: Learning to generate and transfer data with rectified flow</a>
</li>
  <li>[2] <a href="https://arxiv.org/pdf/2403.03206" rel="external nofollow noopener" target="_blank">Scaling Rectified Flow Transformers for High-Resolution Image Synthesis</a>
</li>
</ul>

<p>Rectified Flows define the forward process as straight paths between the data distribution and a standard normal distribution [2], i.e.,</p>

\[z_t = (1 - t) x_0 + t \epsilon\]

<p>where \(\epsilon\) is a standard normal random variable and \(t\) is the time step in [0, 1].</p>

<!-- mkdir -p assets/img/diffusion-foundation -->
<!-- mv _posts/2025-03-20-*.png assets/img/diffusion-foundation/ -->

    </div>
  </article>


  
    
    <br>
    <hr>
    <br>
    <ul class="list-disc pl-8"></ul>

    <!-- Adds related posts to the end of an article -->
    <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2>
    <p class="mb-2">Here are some more articles you might like to read next:</p>
  

  <li class="my-2">
    <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/nlp-foundation/">LLM Series - Part 1 - Important Concepts in NLP</a>
  </li>

  

  <li class="my-2">
    <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/erasing-concepts/">Fake Taylor Swift and the Adversarial Game of Concept Erasure and Injection</a>
  </li>

  

  <li class="my-2">
    <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/deepseek/">DeepSeek-R1</a>
  </li>

  

  <li class="my-2">
    <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/watermark-diffusion/">Tree-Ring Watermarks - Fingerprints for Diffusion Images that are Invisible and Robust</a>
  </li>

  

  <li class="my-2">
    <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/thoughts/">Random Thoughts and Notes</a>
  </li>

</div>

      
    </div>

    <!-- Footer -->    
    <footer class="fixed-bottom">
      <div class="container mt-0">
        © Copyright 2025 Tuan-Anh  Bui. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>.

      </div>
    </footer>

    <!-- JavaScripts -->
    <!-- jQuery -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

    <!-- Bootsrap & MDB scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script>

    <!-- Masonry & imagesLoaded -->
  <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
  <script defer src="/assets/js/masonry.js" type="text/javascript"></script>
    
  <!-- Medium Zoom JS -->
  <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script>
  <script defer src="/assets/js/zoom.js"></script>

  <!-- Bootstrap Table -->
  <script defer src="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.js"></script>

  <!-- Load Common JS -->
  <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script>
  <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script>
  <script defer src="/assets/js/copy_code.js?c9d9dd48933de3831b3ee5ec9c209cac" type="text/javascript"></script>

    
  <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script>
  <script async src="https://badge.dimensions.ai/badge.js"></script>

    <!-- MathJax -->
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        tags: 'ams'
      }
    };
  </script>
  <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script>
  <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-7KGSMMS9MS"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ window.dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-7KGSMMS9MS');
  </script>
    

<!-- Scrolling Progress Bar -->
<script type="text/javascript">
  /*
   * This JavaScript code has been adapted from the article 
   * https://css-tricks.com/reading-position-indicator/ authored by Pankaj Parashar, 
   * published on the website https://css-tricks.com on the 7th of May, 2014.
   * Couple of changes were made to the original code to make it compatible 
   * with the `al-foio` theme.
   */
  const progressBar = $("#progress");
  /*
   * We set up the bar after all elements are done loading.
   * In some cases, if the images in the page are larger than the intended
   * size they'll have on the page, they'll be resized via CSS to accomodate
   * the desired size. This mistake, however, breaks the computations as the
   * scroll size is computed as soon as the elements finish loading.
   * To account for this, a minimal delay was introduced before computing the
   * values.
   */
  window.onload = function () {
    setTimeout(progressBarSetup, 50);
  };
  /*
   * We set up the bar according to the browser.
   * If the browser supports the progress element we use that.
   * Otherwise, we resize the bar thru CSS styling
   */
  function progressBarSetup() {
    if ("max" in document.createElement("progress")) {
      initializeProgressElement();
      $(document).on("scroll", function() {
        progressBar.attr({ value: getCurrentScrollPosition() });
      });
      $(window).on("resize", initializeProgressElement);
    } else {
      resizeProgressBar();
      $(document).on("scroll", resizeProgressBar);
      $(window).on("resize", resizeProgressBar);
    }
  }
  /*
   * The vertical scroll position is the same as the number of pixels that
   * are hidden from view above the scrollable area. Thus, a value > 0 is
   * how much the user has scrolled from the top
   */
  function getCurrentScrollPosition() {
    return $(window).scrollTop();
  }

  function initializeProgressElement() {
    let navbarHeight = $("#navbar").outerHeight(true);
    $("body").css({ "padding-top": navbarHeight });
    $("progress-container").css({ "padding-top": navbarHeight });
    progressBar.css({ top: navbarHeight });
    progressBar.attr({
      max: getDistanceToScroll(),
      value: getCurrentScrollPosition(),
    });
  }
  /*
   * The offset between the html document height and the browser viewport
   * height will be greater than zero if vertical scroll is possible.
   * This is the distance the user can scroll
   */
  function getDistanceToScroll() {
    return $(document).height() - $(window).height();
  }

  function resizeProgressBar() {
    progressBar.css({ width: getWidthPercentage() + "%" });
  }
  // The scroll ratio equals the percentage to resize the bar
  function getWidthPercentage() {
    return (getCurrentScrollPosition() / getDistanceToScroll()) * 100;
  }
</script>

    
  </body>
</html>
